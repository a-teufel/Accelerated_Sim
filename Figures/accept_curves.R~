library(shape)
library(cowplot)
library(grid)
require(gridExtra)
#draws the prob of accepting a mutation as depended on temp and pop size

#helper functions to calcuate fitness
f<-function(b, thresh,x){
	return( 1/(exp(b*(x-thresh/2))+1))
}


f2<-function(b, thresh,x){
	return( exp(b*(x-thresh/2))+1)
}


a<-function(i,j,N,beta){

thresh<--100

xi<--log(f2(beta,thresh,i))
xj<--log(f2(beta,thresh,j))

if(xj > xi){
  return(1)
}
return( exp(-2*N*(xi-xj)))

}

#fitness to iter over
fit1<-seq(from=(-53.6-15),to=(-53.6+15),by=.01)
fit2<--100

fitness<-log(f2(1,-100,fit1))

#make each line with different beta value
row_N1_B1<-NULL
for(i in 1:length(fit1)){

  row_N1_B1<-rbind(row_N1_B1,a(fit2,fit1[i],1,.25))
  
}

row_N1_B5<-NULL
for(i in 1:length(fit1)){

  row_N1_B5<-rbind(row_N1_B5,a(fit2,fit1[i],1,.075))
}

row_N1_B2<-NULL
for(i in 1:length(fit1)){

  row_N1_B2<-rbind(row_N1_B2,a(fit2,fit1[i],1,.55))
}

#set up names
te<-expression(symbol('\256'))
nam<-paste(paste("delta"),"G of Mutant")


#put everything in a data frame to make ggplot happy
temp<-data.frame(x=fit1,y=row_N1_B1)

p <- ggplot(temp,aes(x=fit1,y=row_N1_B1))+geom_line()+xlim(c(fit1[1],fit1[length(fit1)]))+ylim(c(0,1))
p<-p+geom_line(aes(x=fit1,y=row_N1_B5),col=c("blue"))
p<-p+geom_line(aes(x=fit1,y=row_N1_B2),col=c("blue"))+
geom_segment(aes(x = fit1[length(fit1)/2]+1, y = .52, xend =  fit1[length(fit1)/2]+1, yend =.58), arrow = arrow(length = unit(0.1, "cm"),type = "closed"))+
geom_segment(aes(x = fit1[length(fit1)/2]-3, y = .58, xend =  fit1[length(fit1)/2]-3, yend =.52), arrow = arrow(length = unit(0.1, "cm"),type = "closed"))+

geom_segment(aes(x = fit1[length(fit1)/2]+.25, y = .5, xend = fit1[length(fit1)/2]+1.75 , yend = .5),size=.05, arrow = arrow(length = unit(0.1, "cm"),type = "closed"))+
geom_segment(aes(x = fit1[length(fit1)/2]-.25, y = .5, xend = fit1[length(fit1)/2]-6.5 , yend = .5),size=.05, arrow = arrow(length = unit(0.1, "cm"),type = "closed"))+

annotate("text",x=fit1[length(fit1)/2]+.5,y=.55,label=paste("beta"),parse=TRUE,col=c("black"))+
annotate("text",x=fit1[length(fit1)/2]-3.5,y=.55,label=paste("beta"),parse=TRUE,col=c("black"))+
xlab(label=expression(paste(Delta,"G of Mutant")))+theme(axis.text.x = element_blank(),axis.ticks.x = element_blank())+
scale_y_continuous(name="Probability of\nAccepting Mutation")

print(fit1[length(fit1)/2])
print(a(fit2,fit1[length(fit1)/2],1,.55))


#change margins and axis
blank_axes_and_thin_margin <- theme(axis.text = element_text(color="black"),
                    axis.title = element_text(color="black"),
                    axis.ticks = element_blank(),
                    panel.grid = element_blank(),
                    panel.border = element_blank(),
		    axis.text.x = element_text(size=24/3, vjust=1.3/3),
 		    axis.title.x = element_text(size=32/3, vjust=-0.25/3),
		    axis.title.x = element_text(size = 30),
                    plot.margin=unit(c(0, 0, 0,0),"mm"))



base <-theme(panel.border=element_blank(), axis.line=element_line())

#combine the base theme changes and the graph
p<-p+base


#make curves for differnt N values
row_N10_B1<-NULL
for(i in 1:length(fit1)){

  row_N10_B1<-rbind(row_N10_B1,a(fit2,fit1[i],.5,.25))
}


row_N100_B1<-NULL
for(i in 1:length(fit1)){

  row_N100_B1<-rbind(row_N100_B1,a(fit2,fit1[i],2,.25))
}

row_N1000_B1<-NULL
for(i in 1:length(fit1)){

  row_N1000_B1<-rbind(row_N1000_B1,a(fit2,fit1[i],1000,.25))
}

#jam into data frame
temp<-data.frame(x=fit1,y=row_N1_B1)

p2 <- ggplot(temp,aes(x=fit1,y=row_N1_B1))+geom_line()
p2<-p2+geom_line(aes(x=fit1,y=row_N10_B1),col=c("red"))
p2<-p2+geom_line(aes(x=fit1,y=row_N100_B1),col=c("red"))+
geom_segment(aes(x = fit1[length(fit1)/2]+1.75, y = .58, xend =  fit1[length(fit1)/2]+1.75, yend =.52), arrow = arrow(length = unit(0.1, "cm"),type = "closed"))+
geom_segment(aes(x = fit1[length(fit1)/2]-1.25, y = .52, xend =  fit1[length(fit1)/2]-1.25, yend =.58), arrow = arrow(length = unit(0.1, "cm"),type = "closed"))+

geom_segment(aes(x = fit1[length(fit1)/2]+.25, y = .5, xend = fit1[length(fit1)/2]+3.25 , yend = .5),size=.05, arrow = arrow(length = unit(0.1, "cm"),type = "closed"))+
geom_segment(aes(x = fit1[length(fit1)/2]-.25, y = .5, xend = fit1[length(fit1)/2]-2.75 , yend = .5),size=.05, arrow = arrow(length = unit(0.1, "cm"),type = "closed"))+

annotate("text",x=fit1[length(fit1)/2]+1,y=.55,label=paste("N[e]"),parse=TRUE,col=c("black"))+
annotate("text",x=fit1[length(fit1)/2]-2,y=.55,label=paste("N[e]"),parse=TRUE,col=c("black"))+
xlab(label=expression(paste(Delta,"G of Mutant")))+theme(axis.text.x = element_blank(),axis.ticks.x = element_blank())+
scale_y_continuous(name="Probability of\nAccepting Mutation")
p2<-p2+base

#put everything into a list so plot_grid will be happy
t<-list()
t[[1]]<-p
t[[2]]<-p2

s<-plot_grid(plotlist=t,labels=c("A","B"),nrow=2)
s


#legend("topright", c("N = 1, B = 1","N = 1, B = .5","N = 1, B = 2", "N = 10, B = 1","N = 100, B = 1","N = 1000, B = 1") , cex=0.8, col=c("black","blue","green","red","cyan","purple"), 
   #lty=c(1,1,1,2,2,2), lwd=2, bty="n");

